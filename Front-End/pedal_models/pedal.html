<!-- Defines element markup -->
<template>
    <style>
       
    </style>

	<div class="pedal">
		
		<!-- <p class="knob-label" id="knob1-label" contenteditable="true">FREQ</p> -->
		<div class="switchCont" id="switch1">
			<img id="background-image" >
			<webaudio-switch src="../img/switches/switch_1.png" class="switch" id="switch1" height="64" width="128"></webaudio-switch>
		</div>
		
	</div>

    
</template>

<script src="./pedalElementManager.js"></script>

<script>

    (function(window, document, undefined) {
    
        // Refers to the "importer", which is index.html
        var thatDoc = document;

        // Refers to the "importee", which is vimeo-embed.html
        var thisDoc = (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;

        // Gets content from <template>.
        var template = thisDoc.querySelector( 'template' );
		

        // Shim Shadow DOM styles if needed
        if (window.ShadowDOMPolyfill) {
            WebComponents.ShadowCSS.shimStyling(template.content, 'pedal');
        }
	
		let BACKGROUND_IMAGES_URL = './img/background/';


        class Pedal extends HTMLElement {
			static get observedAttributes() {
    			return ['color', 'width', 'height', 'radius', 'background-image', 'opacity'];
  			}
			

            constructor(wi) {
                super();
				this.knobs = [];
				this.icons = [];
				this.switches = [];
				this.sliders = [];
				this.backgroundImageSrc = null;
				this.selectedElement = null;
				this.pedalId = null;
				this.name = null;
				this.pedalElementManager = new PedalElementManager(this, thatDoc);
            }
			
			/********************************* Add Pedal Elements Config ************************************/

			addElement(type, filename) {
				return this.pedalElementManager.addElement(type, filename);
			}
			
			/********************************* Deleting Pedal Elements ************************************/

			deleteSelectedElement() {
				this.pedalElementManager.deleteElement(this.selectedElement.id);
				this.selectedElement = null;
			}
			
			getElements() {
				return this.knobs.concat(this.icons.concat(this.switches.concat(this.sliders)));
			}

			getElementsTypes() {
				return ['knob', 'icon', 'switch', 'slider'];
			}

			getKnobs() {
				return this.knobs;
			}

			getIcons() {
				return this.icons;
			}

			setBackgroundImage(imageName) {
				this.backgroundImageSrc = imageName;
				let backgroundImageElem = this.shadowRoot.querySelector('#background-image');
				backgroundImageElem.setAttribute('src', './img/background/' + imageName);
			}

			setSrc(src) {
				this.src = src;
			}

            connectedCallback() {
                var shadowRoot = this.attachShadow({mode:'open'});
    
                var clone = thatDoc.importNode( template.content, true );
                shadowRoot.appendChild(clone);
				this.updateStyle(this);
			}

			updateStyle_() {
				this.updateStyle(this);
			}


			getSelectedElement() {
				return this.selectedElement;
			}

			selectElement(elementId) {
				for(let knob of this.knobs) {
					if(knob.id === elementId) {
						this.selectedElement = knob;
					}
				}

				for(let icon of this.icons) {
					if(icon.id === elementId) {
						this.selectedElement = icon;
					}
				}

				for(let s of this.switches) {
					if(s.id === elementId) {
						this.selectedElement = s;
					}
				}

				for(let slider of this.sliders) {
					if(slider.id === elementId) {
						this.selectedElement = slider;
					}
				}

				this.highlightElement(elementId);
				
				this.updateStyle(this);
				let evt = new CustomEvent('select-knob', {detail: elementId});
				this.dispatchEvent(evt);
				  
			}

			highlightElement(elementId) {
				var shadow = this.shadowRoot;
				
				for(let i = 0; i < this.knobs.length; i++) {
					let knob = shadow.querySelectorAll('.knob')[i];
					knob.className = knob.className.replace('selected', '');
				}

				for(let i = 0; i < this.icons.length; i++) {
					let icon = shadow.querySelectorAll('.icon')[i];
					icon.className = icon.className.replace('selected', '');
				}

				for(let i = 0; i < this.switches.length; i++) {
					let s = shadow.querySelectorAll('.switch')[i+1];
					s.className = s.className.replace('selected', '');
				}

				for(let i = 0; i < this.sliders.length; i++) {
					let slider = shadow.querySelectorAll('.slider')[i];
					slider.className = slider.className.replace('selected', '');
				}
				
				let selectedElement = shadow.querySelector('#' + elementId);
				selectedElement.className += " selected";
			}
			
			generateStyle(functional) {
				let nonFuncitonalPedalStyle = `
							.pedal{
								display: block;
								background-color: ${this.getAttribute('color')};
								width: ${this.getAttribute('width')}px;
								height: ${this.getAttribute('height')}px;
								border-radius: ${this.getAttribute('radius')}px;
								position: fixed;
								top: 40%;
								left: 50%;
								/* bring your own prefixes */
								transform: translate(-50%, -50%);
							}`;

				let functionalPedalStyle = `
							.pedal{
								display: block;
								background-color: ${this.getAttribute('color')};
								width: ${this.getAttribute('width')}px;
								height: ${this.getAttribute('height')}px;
								border-radius: ${this.getAttribute('radius')}px;
								position: relative;
								/* bring your own prefixes */
							}
				`;



				return `	${functional ? functionalPedalStyle : nonFuncitonalPedalStyle}
							
							#background-image {
								//border: solid 2px black;
								width: ${this.getAttribute('width')}px;
								height: ${this.getAttribute('height')}px;
								opacity: ${this.getAttribute('opacity')};
							}

							.knob, .switch, .icon{
								position: absolute;
								cursor: pointer;
							}

						

							.selected {
								border: 1px dashed black;
								cursor: move;
							}

							.selected:hover {
								border: 1px dashed black;
								cursor: move;
							}

							.selected  webaudio-knob{
								cursor: move;
							}

							.selected  webaudio-switch{
								cursor: move;
							}

							.selected  webaudio-slider{
								cursor: move;
							}

							.selected:hover webaudio-knob{
								cursor: move;
							}

							.selected:hover webaudio-switch{
								cursor: move;
							}
							
							.selected:hover webaudio-slider{
								cursor: move;
							}


							#switch1 {
								bottom: 10px;
								right: 0px;
							}
							${this.generateElementsStyles()}
							
							.pedalLabel{
								position: absolute;
								top: 225px;
								font-size: 25px;
								font-family: Sansita;/*{font}*/
								text-align: center;
								line-height: 30px;/*{pedalfontsize}*/
								width: 150px;
								color: #6B0000;/*{fontcolor}*/
							}
							.knob-label{
								position: absolute;
								font-size: 12px;/*{knobfontsize}*/
								line-height: 12px;
								width:64px;
								max-width:64px;
								overflow: hidden;
								text-align: center;
								font-family: Sansita;/*{font}*/
								color: #6B0000;/*{fontcolor}*/
							}
							#knob1-label{
								top: 84px;
								left: 43px;
							}`
			}

			updateStyle(elem) {
				var shadow = elem.shadowRoot;
				var childNodes = shadow.childNodes;
				
				for(var childNode of childNodes) {
					if(childNode.nodeName === 'STYLE') {				

						childNode.textContent = this.generateStyle(false);
					}
				}
			}

			generateElementsStyles() {
				let ret = '';
				for(let knob of this.knobs) {
					ret += `
						#${knob.id} {
							left: ${knob.x}px;
							top: ${knob.y}px;
						}

						#${knob.id} div {
							color: #${knob.label_color};
							font-family: "${knob.label_fontfamily}";
							font-size: ${knob.label_fontsize}px;
							
						}
					`
					let knobContainer = this.shadowRoot.querySelector('#'+knob.id);

					knobContainer.innerHTML = '';					


					var knobElem = thatDoc.createElement("webaudio-knob");
					knobElem.src = '../img/knobs/' + knob.model;
					knobElem.setAttribute('src', '../img/knobs/' + knob.model);
        			knobElem.setAttribute('height', knob.height);
					knobElem.setAttribute('width', knob.width);
					knobElem.setAttribute('sprites', 100);
        			knobElem.setAttribute('step', 1);
					knobElem.value = knob.value;
					knobElem.setAttribute('value', knob.value);
					
					knobContainer.appendChild(knobElem);
					
					let labelElem = thatDoc.createElement("div");
					labelElem.innerHTML = knob.label;
					knobContainer.appendChild(labelElem);

					
				}

				for(let s of this.switches) {
					ret += `
						#${s.id} {
							left: ${s.x}px;
							top: ${s.y}px;
						}

						#${s.id} div {
							color: #${s.label_color};
							font-family: "${s.label_fontfamily}";
							font-size: ${s.label_fontsize}px;
							
						}
					`
					let switchContainer = this.shadowRoot.querySelector('#'+s.id);

					switchContainer.innerHTML = '';

					var switchElem = thatDoc.createElement("webaudio-switch");
        			switchElem.setAttribute('src', '../img/switches/' + s.model);
        			switchElem.setAttribute('height', s.height);
					switchElem.setAttribute('width', s.width);
					
					switchContainer.appendChild(switchElem);
				

					let labelElem = thatDoc.createElement("div");
					labelElem.innerHTML = s.label;
					switchContainer.appendChild(labelElem);
					
				}

				for(let slider of this.sliders) {
					ret += `
						#${slider.id} {
							left: ${slider.x}px;
							top: ${slider.y}px;
						}

						#${slider.id} div {
							color: #${slider.label_color};
							font-family: "${slider.label_fontfamily}";
							font-size: ${slider.label_fontsize}px;
							
						}
					`
					let sliderContainer = this.shadowRoot.querySelector('#'+slider.id);

					let sliderElem = sliderContainer.childNodes[0];
					sliderElem.value = slider.value;
					sliderElem.setAttribute('value', slider.value);

					sliderElem.src = '../img/sliders/' + slider.model;
					sliderElem.setAttribute('src', '../img/sliders/' + slider.model);

					let labelElem = sliderContainer.childNodes[1];
					labelElem.innerHTML = slider.label;
					
				}

				for(let icon of this.icons) {
					ret += `
							#${icon.id} {
								left: ${icon.x}px;
								top: ${icon.y}px;
								width: ${icon.width}px;
								height: ${icon.height}px;
							}
						`
						
				}

				
				return ret;

			}
			
			attributeChangedCallback(name, oldValue, newValue) {
  				this.updateStyle(this);
			}
			
			/**
			 ** Loads and sets the configuration of the pedal from a json file. 
			 */
			loadConfig(config) {
				this.pedalId = config.id;
				this.name = config.name;
				
				// Removing the old knobs
				for(let knob of this.knobs) {
					this.removeKnobDom(knob.id);
				}
				this.knobs = [];

				for(let element of config.elements) {
					
					if(element.type == 'knob') {
						let knob = this.addElement('knob');
						knob.x = element.x;
						knob.y = element.y;
						knob.model = element.model;
						knob.value = element.value;
						knob.label = element.label;
						knob.label_fontfamily = element.label_fontfamily;
						knob.label_fontsize = element.label_fontsize;
						knob.label_color = element.label_color;
						knob.type = element.type;
					} else if(element.type === 'icon') {
						let icon = this.addElement('icon', element.file);
						icon.x = element.x;
						icon.y = element.y;
						icon.width = element.width;
						icon.height = element.height;
						icon.file = element.file;
						icon.type = element.type;
					}
				}

				this.setAttribute('width', config.width);
				this.setAttribute('color', config.color);
				this.setAttribute('height', config.height);
				this.setAttribute('radius', config.radius);
				this.setBackgroundImage(config.backgroundImageSrc);
			}

			removeKnobDom(knobId) {
				let knobElem = this.shadowRoot.querySelector('#' + knobId);
				knobElem.remove();
			}

			getConfig() {
				let config = {
					id: this.pedalId,
					name: this.name,
					backgroundImageSrc: this.backgroundImageSrc,
					color: this.getAttribute('color'),
        			width: this.getAttribute('width'),
        			height: this.getAttribute('height'),
        			radius: this.getAttribute('radius'),
					elements: []
				};

				for(let knob of this.knobs) {
					config.elements.push(knob);
				}

				for(let icon of this.icons) {
					config.elements.push(icon);
				}

				return config;
			}
			
			/* 
			 * Generates the code of the functional pedal.
			 */
			generateCodeFunctionalPedal() {
				//console.log(this.getFunctionPedalTemplate());
			}
			
			/*
			 * Gets the style content of the function pedal.
			 */
			getStyle() {
				let style = this.shadowRoot.childNodes[1].cloneNode(true);
				style.innerHTML = this.generateStyle(true);	
				return style;

			}
			
			/*
			 * Gets the html content of the function pedal.
			 */
			getHtml() {
				let html = this.shadowRoot.childNodes[3].cloneNode(true);
				
				for(let elem of html.querySelectorAll('webaudio-knob')) {
					elem.innerHTML = '';

				}
				
				for(let elem of html.querySelectorAll('.switch')) {
					elem.innerHTML = '';

				}

				for(let elem of html.querySelectorAll('.knob')) {
					elem.className = elem.className.replace('selected', '');
					for(let knob of this.knobs) {
						if(elem.id == knob.id) {
							let knobElem = elem.childNodes[0];

						}
					}
				}

				return html;
			}

		}


        window.customElements.define('my-pedal', Pedal);


    })(window, document);
</script>